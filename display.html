<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indonesia Map - Location Tracker</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent; /* Transparent for OBS */
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background: transparent;
        }

        /* Custom map styling - WHITE THEME */
        .leaflet-container {
            background: transparent !important;
        }

        /* Custom marker styles */
        .city-marker {
            background: #FF0000;
            border: 2px solid #FFFFFF;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .city-marker.pulse {
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
            }
            50% {
                transform: scale(1.3);
                box-shadow: 0 4px 16px rgba(255, 0, 0, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
            }
        }

        /* Reset button */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .btn-reset {
            background: rgba(255, 255, 255, 0.95);
            color: #FF0000;
            border: 2px solid #FF0000;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .btn-reset:hover {
            background: #FF0000;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 0, 0, 0.4);
        }

        /* Leaflet attribution - hide or style */
        .leaflet-control-attribution {
            display: none; /* Hide for clean OBS display */
        }

        /* Loading indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 2000;
        }

        .loading.hidden {
            display: none;
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #FF0000;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-content {
            margin: 12px;
            font-size: 14px;
            color: #333;
        }

        .popup-city {
            font-size: 18px;
            font-weight: bold;
            color: #FF0000;
            margin-bottom: 8px;
        }

        .popup-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .leaflet-popup-tip {
            background: white;
            border: 2px solid #FF0000;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">‚è≥ Loading Map...</div>
    
    <div class="controls">
        <button class="btn-reset" id="btnReset">üóëÔ∏è Reset Map</button>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Get Room ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        if (!roomId) {
            alert('‚ö†Ô∏è No Room ID provided!\n\nPlease use: map-display.html?room=MAP-XXXNNN');
        }

        console.log('üó∫Ô∏è Map Display Loaded - Room:', roomId);

        // Supabase config
        const SUPABASE_URL = 'https://qeoszqrunkgqkoolqbpa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3N6cXJ1bmtncWtvb2xxYnBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDQzMTgsImV4cCI6MjA4MDE4MDMxOH0.h_Xnid8Jnnmi-yr3YraB-I9GhTX-H6b9952hO90Mqxg';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Initialize map centered on Indonesia
        const map = L.map('map', {
            zoomControl: true,
            attributionControl: false
        }).setView([-2.5, 118], 5); // Center of Indonesia

        // WHITE THEME TILE LAYER
        // Using CartoDB Positron (light/white theme)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        // Alternative WHITE themes (uncomment to use):
        
        // Option 2: Stamen Toner Lite (very minimal white)
        // L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.png', {
        //     maxZoom: 19,
        //     subdomains: 'abcd'
        // }).addTo(map);

        // Option 3: OpenStreetMap Standard (with custom filter for white)
        // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     maxZoom: 19,
        //     className: 'map-tiles-white' // Add CSS filter
        // }).addTo(map);

        // Markers storage
        const markers = {};

        // Calculate marker size based on vote count (2x bigger than before)
        function getMarkerSize(count) {
            if (count === 1) return 20;      // was 10
            if (count <= 4) return 30;       // was 15
            if (count <= 9) return 50;       // was 25
            if (count <= 19) return 80;      // was 40
            return 120; // 20+ votes (was 60)
        }

        // Create custom marker
        function createMarker(lat, lng, cityDisplay, voteCount) {
            const size = getMarkerSize(voteCount);
            
            const icon = L.divIcon({
                className: 'city-marker',
                html: '',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });

            const marker = L.marker([lat, lng], { icon })
                .bindPopup(`
                    <div class="popup-city">${cityDisplay}</div>
                    <div class="popup-count">${voteCount} vote${voteCount > 1 ? 's' : ''}</div>
                `)
                .addTo(map);

            return marker;
        }

        // Update marker size
        function updateMarker(cityName, voteCount) {
            if (markers[cityName]) {
                const size = getMarkerSize(voteCount);
                const marker = markers[cityName];
                
                // Update icon size
                const icon = L.divIcon({
                    className: 'city-marker pulse', // Add pulse animation
                    html: '',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
                
                marker.setIcon(icon);
                
                // Update popup
                marker.setPopupContent(`
                    <div class="popup-city">${marker.cityDisplay}</div>
                    <div class="popup-count">${voteCount} vote${voteCount > 1 ? 's' : ''}</div>
                `);

                // Remove pulse class after animation
                setTimeout(() => {
                    const icon = L.divIcon({
                        className: 'city-marker',
                        html: '',
                        iconSize: [size, size],
                        iconAnchor: [size/2, size/2]
                    });
                    marker.setIcon(icon);
                }, 600);

                console.log(`üìà Updated: ${cityName} ‚Üí ${voteCount} votes (size: ${size}px)`);
            }
        }

        // Load existing votes
        async function loadVotes() {
            try {
                const { data, error } = await supabase
                    .from('map_votes')
                    .select('*')
                    .eq('room_id', roomId);

                if (error) throw error;

                console.log(`üìä Loaded ${data.length} existing votes`);

                data.forEach(vote => {
                    const marker = createMarker(
                        vote.latitude,
                        vote.longitude,
                        vote.city_display,
                        vote.vote_count
                    );
                    
                    marker.cityDisplay = vote.city_display;
                    markers[vote.city_name] = marker;
                });

                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('‚ùå Error loading votes:', error);
                document.getElementById('loading').textContent = '‚ùå Error loading data';
            }
        }

        // Subscribe to real-time updates
        function subscribeToUpdates() {
            const channel = supabase
                .channel('map-updates')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'map_votes',
                        filter: `room_id=eq.${roomId}`
                    },
                    (payload) => {
                        console.log('üîÑ Real-time update:', payload);

                        if (payload.eventType === 'INSERT') {
                            const vote = payload.new;
                            const marker = createMarker(
                                vote.latitude,
                                vote.longitude,
                                vote.city_display,
                                vote.vote_count
                            );
                            marker.cityDisplay = vote.city_display;
                            markers[vote.city_name] = marker;
                            
                            console.log(`‚úÖ New city: ${vote.city_display}`);
                        } else if (payload.eventType === 'UPDATE') {
                            const vote = payload.new;
                            updateMarker(vote.city_name, vote.vote_count);
                        } else if (payload.eventType === 'DELETE') {
                            // Handle delete (for reset)
                            const cityName = payload.old.city_name;
                            if (markers[cityName]) {
                                map.removeLayer(markers[cityName]);
                                delete markers[cityName];
                                console.log(`üóëÔ∏è Removed: ${cityName}`);
                            }
                        }
                    }
                )
                .subscribe();

            console.log('‚úÖ Subscribed to real-time updates');
        }

        // Reset button
        document.getElementById('btnReset').addEventListener('click', async () => {
            if (!confirm('üóëÔ∏è Reset all votes for this room?')) return;

            try {
                const { error } = await supabase
                    .from('map_votes')
                    .delete()
                    .eq('room_id', roomId);

                if (error) throw error;

                // Clear all markers
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};

                console.log('‚úÖ Map reset');
                alert('‚úÖ Map reset successfully!');
            } catch (error) {
                console.error('‚ùå Reset error:', error);
                alert('‚ùå Error resetting map: ' + error.message);
            }
        });

        // Initialize
        loadVotes();
        subscribeToUpdates();

        console.log('‚úÖ Map initialized - Room:', roomId);
    </script>
</body>
</html>
